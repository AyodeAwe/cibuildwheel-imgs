name: Delete temporary images

on:
  workflow_call:
    inputs:
      CUDA_VER:
        required: true
        type: string
      LINUX_VER:
        required: true
        type: string
      PYTHON_VER:
        required: true
        type: string
      IMAGE_REPO:
        required: true
        type: string
      ARCHES:
        required: true
        type: string
      BUILD_TYPE:
        required: true
        type: string

jobs:
  get-prefix:
    runs-on: ubuntu-latest
    outputs:
      FULL_PREFIX: ${{ steps.get-prefix.outputs.FULL_PREFIX }}
      USED_REPO: ${{ steps.get-prefix.outputs.USED_REPO }}
      TAG_PREFIX: ${{ steps.get-prefix.outputs.TAG_PREFIX }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Compute Prefix
        id: get-prefix
        uses: ./.github/actions/compute-prefix
        with:
          ORIGINAL_PREFIX: rapidsai/${{ inputs.IMAGE_REPO }}
          IMAGE_REPOSITORY: ${{ inputs.IMAGE_REPO }}
          BUILD_TYPE: ${{ inputs.BUILD_TYPE }}
  delete-temp-images:
    runs-on: ubuntu-latest
    needs: get-prefix
    if: always()
    steps:
      - name: Remove temporary images
        run: |
            HUB_TOKEN=$(
                curl -s -H "Content-Type: application/json" \
                -X POST \
                -d "{\"username\": \"${{ secrets.GPUCIBOT_DOCKERHUB_USER }}\", \"password\": \"${{ secrets.GPUCIBOT_DOCKERHUB_TOKEN }}\"}" \
                https://hub.docker.com/v2/users/login/ | jq -r .token \
            )

            org="rapidsai"
            repo="${{ needs.get-prefix.outputs.USED_REPO }}"
            tag="${{ needs.get-prefix.outputs.TAG_PREFIX }}cuda${{ inputs.CUDA_VER }}-${{ inputs.LINUX_VER }}-py${{ inputs.PYTHON_VER }}"

            for arch in $(echo '${{ inputs.ARCHES }}' | jq .[] -r); do
                curl -i -X DELETE \
                -H "Accept: application/json" \
                -H "Authorization: JWT $HUB_TOKEN" \
                "https://hub.docker.com/v2/repositories/$org/$repo/tags/$tag-$arch/"
            done

            # for PRs, delete the multi-arch image
            if [[ "${{ inputs.BUILD_TYPE }}" == "pull-request" ]]; then
                curl -i -X DELETE \
                -H "Accept: application/json" \
                -H "Authorization: JWT $HUB_TOKEN" \
                "https://hub.docker.com/v2/repositories/$org/$repo/tags/$tag/"
            fi